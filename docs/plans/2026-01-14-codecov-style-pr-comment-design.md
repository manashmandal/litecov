# Codecov-Style PR Comment Design

## Overview

Enhance litecov's PR comment format to replicate Codecov's visual styling, including:
- Header with emoji status indicator and quick summary
- Coverage diff table with `diff` syntax highlighting
- Impacted files in collapsible section with status indicators
- GitHub workflow annotations for uncovered lines

## Current State

The current `comment.Format()` produces a basic markdown table:
- Simple metric table (coverage, lines, files)
- File list with coverage percentages
- Basic footer

## Target Design

### PR Comment Structure

```markdown
<!-- litecov -->
## üìä Coverage Report

> ‚úÖ **Coverage: `91.51%`** (+0.07%) | **Patch: `85.00%`** | **Files: `234`**

<details>
<summary>Coverage Diff</summary>

` ` `diff
@@            Coverage Diff             @@
##             main     #123      +/-   ##
==========================================
+ Coverage   91.44%   91.51%   +0.07%
==========================================
  Files         234      234
  Lines       28655    28700      +45
==========================================
+ Hits        26204    26260      +56
- Misses       2451     2440      -11
` ` `

</details>

<details>
<summary>Impacted Files (5)</summary>

| File | Coverage | Œî | Status |
|------|----------|---|--------|
| [`src/parser/lcov.go`](link) | `94.20%` | `+2.10%` | ‚úÖ |
| [`src/coverage/report.go`](link) | `87.50%` | `+5.00%` | ‚úÖ |
| [`src/comment/format.go`](link) | `72.00%` | `-3.00%` | ‚ö†Ô∏è |
| [`internal/diff/diff.go`](link) | `65.00%` | `new` | ‚ùå |

</details>

---
<sub>üìà Generated by [LiteCov](https://github.com/manashmandal/litecov)</sub>
```

### Status Indicators

| Coverage | Emoji | Meaning |
|----------|-------|---------|
| ‚â•80% | ‚úÖ | Good coverage |
| 50-79% | ‚ö†Ô∏è | Needs improvement |
| <50% | ‚ùå | Poor coverage |

### Change Indicators

| Change | Symbol |
|--------|--------|
| Increased | `+X.XX%` (green in diff) |
| Decreased | `-X.XX%` (red in diff) |
| New file | `new` |
| No change | `√∏` |

## Implementation Changes

### 1. Extend `coverage.Report` Structure

Add fields for comparison data:

```go
type Report struct {
    Files        []FileCoverage
    TotalCovered int
    TotalLines   int
    Coverage     float64
    // New fields for comparison
    BaseCoverage  float64  // Coverage from base branch
    PatchCoverage float64  // Coverage of changed lines only
    BaseReport    *Report  // Optional: full base report for diff
}

type FileCoverage struct {
    Path           string
    LinesCovered   int
    LinesTotal     int
    UncoveredLines []int
    // New fields
    BaseCoverage   float64  // Previous coverage (0 if new file)
    IsNew          bool
    IsDeleted      bool
}
```

### 2. Update `comment.Options`

```go
type Options struct {
    Title        string
    ShowFiles    string
    ChangedFiles []string
    Threshold    float64
    WorstN       int
    RepoURL      string
    SHA          string
    PRNumber     int
    // New fields
    BaseBranch   string   // e.g., "main"
    BaseReport   *coverage.Report  // For comparison
    CompareMode  string   // "base", "patch", "none"
}
```

### 3. New Comment Formatting Functions

```go
// Format header with status emoji and summary
func formatHeader(report *coverage.Report, opts Options) string

// Format coverage diff table with +/- indicators
func formatCoverageDiff(current, base *coverage.Report) string

// Format impacted files with status indicators
func formatImpactedFiles(files []coverage.FileCoverage, opts Options) string

// Get status emoji based on coverage percentage
func getStatusEmoji(coverage float64) string

// Get change indicator string
func getChangeIndicator(current, base float64, isNew bool) string
```

### 4. Enhanced Annotations

Group consecutive uncovered lines and output as ranges:

```go
func outputAnnotations(report *coverage.Report, changedFiles []string) {
    for _, file := range report.Files {
        // Only annotate changed files
        if !isChangedFile(file.Path, changedFiles) {
            continue
        }

        ranges := groupConsecutiveLines(file.UncoveredLines)
        for _, r := range ranges {
            if r.Start == r.End {
                fmt.Printf("::warning file=%s,line=%d,title=Uncovered::Line not covered\n",
                    file.Path, r.Start)
            } else {
                fmt.Printf("::warning file=%s,line=%d,endLine=%d,title=Uncovered::Lines %d-%d not covered\n",
                    file.Path, r.Start, r.End, r.Start, r.End)
            }
        }
    }
}
```

### 5. New Action Inputs

```yaml
inputs:
  compare-mode:
    description: 'Comparison mode: base, patch, none'
    required: false
    default: 'base'
  base-coverage-file:
    description: 'Path to base branch coverage for comparison'
    required: false
  annotation-limit:
    description: 'Max annotations per file (0 = unlimited)'
    required: false
    default: '10'
```

## File Changes Required

1. `internal/coverage/coverage.go` - Extend Report and FileCoverage structs
2. `internal/comment/comment.go` - New formatting functions for Codecov style
3. `cmd/litecov/main.go` - Handle comparison mode and base coverage
4. `action.yml` - Add new inputs
5. `internal/comment/comment_test.go` - Update tests for new format

## Testing

- Verify diff syntax highlighting renders correctly on GitHub
- Test collapsible sections expand/collapse properly
- Validate emoji rendering across platforms
- Test annotation limits and grouping
- Verify links work correctly in PR comments
