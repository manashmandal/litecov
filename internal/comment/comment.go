package comment

import (
	"fmt"
	"strings"

	"github.com/litecov/litecov/internal/coverage"
)

const marker = "<!-- litecov -->"

// Options configures comment formatting
type Options struct {
	Title        string
	ShowFiles    string   // all, changed, threshold:N, worst:N
	ChangedFiles []string // files changed in PR (for ShowFiles=changed)
	Threshold    float64  // threshold for ShowFiles=threshold:N
	WorstN       int      // N for ShowFiles=worst:N
}

// Format generates a markdown comment from a coverage report
func Format(report *coverage.Report, opts Options) string {
	var sb strings.Builder

	// Marker for identifying our comments
	sb.WriteString(marker)
	sb.WriteString("\n")

	// Header
	sb.WriteString(fmt.Sprintf("## %s\n\n", opts.Title))

	// Summary table
	sb.WriteString("| Metric | Value |\n")
	sb.WriteString("|--------|-------|\n")
	sb.WriteString(fmt.Sprintf("| **Coverage** | `%.2f%%` |\n", report.Coverage))
	sb.WriteString(fmt.Sprintf("| **Lines** | `%d/%d` |\n", report.TotalCovered, report.TotalLines))
	sb.WriteString(fmt.Sprintf("| **Files** | `%d` |\n", len(report.Files)))
	sb.WriteString("\n")

	// Filter files based on ShowFiles option
	filesToShow := filterFiles(report.Files, opts)

	if len(filesToShow) > 0 {
		sb.WriteString("| File | Coverage | |\n")
		sb.WriteString("|------|----------|---|\n")
		for _, f := range filesToShow {
			pct := f.Percentage()
			indicator := ""
			if pct < 50 {
				indicator = " :warning:"
			}
			sb.WriteString(fmt.Sprintf("| `%s` | `%.2f%%` |%s |\n", f.Path, pct, indicator))
		}
		sb.WriteString("\n")
	}

	// Footer
	sb.WriteString("<sub>Generated by [LiteCov](https://github.com/litecov/litecov)</sub>\n")

	return sb.String()
}

// filterFiles returns files matching the ShowFiles criteria
func filterFiles(files []coverage.FileCoverage, opts Options) []coverage.FileCoverage {
	switch {
	case opts.ShowFiles == "all":
		return files

	case opts.ShowFiles == "changed":
		if len(opts.ChangedFiles) == 0 {
			return files
		}
		changedSet := make(map[string]bool)
		for _, f := range opts.ChangedFiles {
			changedSet[f] = true
		}
		var result []coverage.FileCoverage
		for _, f := range files {
			if changedSet[f.Path] {
				result = append(result, f)
			}
		}
		return result

	case strings.HasPrefix(opts.ShowFiles, "threshold:"):
		var result []coverage.FileCoverage
		for _, f := range files {
			if f.Percentage() < opts.Threshold {
				result = append(result, f)
			}
		}
		return result

	case strings.HasPrefix(opts.ShowFiles, "worst:"):
		// Sort by coverage ascending and take first N
		sorted := make([]coverage.FileCoverage, len(files))
		copy(sorted, files)
		// Simple bubble sort for small N
		for i := 0; i < len(sorted)-1; i++ {
			for j := 0; j < len(sorted)-i-1; j++ {
				if sorted[j].Percentage() > sorted[j+1].Percentage() {
					sorted[j], sorted[j+1] = sorted[j+1], sorted[j]
				}
			}
		}
		if opts.WorstN > len(sorted) {
			return sorted
		}
		return sorted[:opts.WorstN]

	default:
		return files
	}
}

// GetMarker returns the comment marker for identifying litecov comments
func GetMarker() string {
	return marker
}
